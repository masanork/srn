<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sorane PassKey Authorization</title>
    <style>
        body { font-family: system-ui, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #0f172a; color: white; }
        .card { background: #1e293b; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); text-align: center; max-width: 400px; }
        button { background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-size: 1rem; cursor: pointer; margin-top: 1rem; }
        button:hover { background: #2563eb; }
        #status { margin-top: 1rem; color: #94a3b8; }
        pre { text-align: left; background: #000; padding: 1rem; border-radius: 0.5rem; font-size: 0.8rem; overflow: auto; max-height: 200px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîê Sorane Authorization</h1>
        <p>Authorize a new build key using your PassKey.</p>
        <div id="action-area">
            <button id="auth-btn">Authorize Build</button>
        </div>
        <div id="status">Ready</div>
        <div id="details" style="display:none">
            <h3>Certificate Details</h3>
            <pre id="cert-view"></pre>
        </div>
    </div>

    <script type="module">
        const authBtn = document.getElementById('auth-btn');
        const status = document.getElementById('status');

        authBtn.onclick = async () => {
            status.textContent = "Requesting challenge from local server...";
            
            try {
                const sessionResponse = await fetch('/session');
                const session = await sessionResponse.json();
                
                status.textContent = "Please confirm on your device...";
                
                // WebAuthn Ceremony (get)
                const options = {
                    publicKey: {
                        challenge: Uint8Array.from(atob(session.challenge), c => c.charCodeAt(0)),
                        allowCredentials: [{
                            id: Uint8Array.from(atob(session.credentialId), c => c.charCodeAt(0)),
                            type: 'public-key'
                        }],
                        userVerification: 'required'
                    }
                };

                const assertion = await navigator.credentials.get(options);
                
                status.textContent = "Verifying signature...";
                
                const response = await fetch('/authorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: assertion.id,
                        rawId: btoa(String.fromCharCode(...new Uint8Array(assertion.rawId))),
                        response: {
                            authenticatorData: btoa(String.fromCharCode(...new Uint8Array(assertion.response.authenticatorData))),
                            clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(assertion.response.clientDataJSON))),
                            signature: btoa(String.fromCharCode(...new Uint8Array(assertion.response.signature))),
                            userHandle: assertion.response.userHandle ? btoa(String.fromCharCode(...new Uint8Array(assertion.response.userHandle))) : null
                        }
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    status.textContent = "‚úÖ Build Authorized!";
                    document.getElementById('details').style.display = 'block';
                    document.getElementById('cert-view').textContent = JSON.stringify(result, null, 2);
                    authBtn.style.display = 'none';
                } else {
                    status.textContent = "‚ùå Authorization failed.";
                }

            } catch (err) {
                console.error(err);
                status.textContent = "‚ùå Error: " + err.message;
            }
        };
    </script>
</body>
</html>
