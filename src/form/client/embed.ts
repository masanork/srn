
// Auto-generated by scripts/build_weba_client.ts
export const CLIENT_BUNDLE = "// src/weba/client/calculator.ts\nclass Calculator {\n  runAutoCopy() {\n    document.querySelectorAll(\"[data-copy-from]\").forEach((dest) => {\n      if (!dest.dataset.dirty) {\n        const srcKey = dest.dataset.copyFrom;\n        if (srcKey) {\n          const row = dest.closest(\"tr\");\n          const scope = row || document;\n          const src = scope.querySelector(`[data-base-key=\"${srcKey}\"], [data-json-path=\"${srcKey}\"]`);\n          if (src && src.value !== dest.value) {\n            dest.value = src.value;\n            dest.dispatchEvent(new Event(\"input\", { bubbles: true }));\n          }\n        }\n      }\n    });\n  }\n  recalculate() {\n    document.querySelectorAll(\"[data-formula]\").forEach((calcField) => {\n      const formula = calcField.dataset.formula;\n      if (!formula)\n        return;\n      const row = calcField.closest(\"tr\");\n      const table = calcField.closest(\"table\");\n      const getValue = (varName) => {\n        let val = 0;\n        let foundSource = \"none\";\n        if (row) {\n          const selector = `[data-base-key=\"${varName}\"], [data-json-path=\"${varName}\"]`;\n          const input = row.querySelector(selector);\n          if (input) {\n            foundSource = \"row-input\";\n            if (input.value !== \"\")\n              val = parseFloat(input.value);\n          }\n        }\n        if (foundSource === \"none\") {\n          const staticInput = document.querySelector(`[data-json-path=\"${varName}\"]`);\n          if (staticInput) {\n            foundSource = \"static-input\";\n            if (staticInput.value !== \"\")\n              val = parseFloat(staticInput.value);\n          }\n        }\n        return val;\n      };\n      let evalStr = formula.replace(/SUM\\(([a-zA-Z0-9_\\-\\u0080-\\uFFFF]+)\\)/g, (_, key) => {\n        let sum = 0;\n        const scope = table || document;\n        let inputs = scope.querySelectorAll(`[data-base-key=\"${key}\"], [data-json-path=\"${key}\"]`);\n        if (inputs.length === 0 && scope !== document) {\n          inputs = document.querySelectorAll(`[data-base-key=\"${key}\"], [data-json-path=\"${key}\"]`);\n        }\n        inputs.forEach((inp) => {\n          const val = parseFloat(inp.value);\n          if (!isNaN(val))\n            sum += val;\n        });\n        return sum;\n      });\n      evalStr = evalStr.replace(/([a-zA-Z_\\u0080-\\uFFFF][a-zA-Z0-9_\\-\\u0080-\\uFFFF]*)/g, (match) => {\n        if ([\"Math\", \"round\", \"floor\", \"ceil\", \"abs\", \"min\", \"max\"].includes(match))\n          return match;\n        return String(getValue(match));\n      });\n      try {\n        const result = new Function(\"return \" + evalStr)();\n        if (typeof result === \"number\" && !isNaN(result)) {\n          calcField.value = Number.isInteger(result) ? result : result.toFixed(0);\n        } else {\n          calcField.value = \"\";\n        }\n      } catch (e) {\n        console.error(\"Calc Error:\", e);\n        calcField.value = \"Err\";\n      }\n    });\n    this.runAutoCopy();\n  }\n}\n\n// src/weba/client/data.ts\nclass DataManager {\n  formId;\n  constructor() {\n    this.formId = \"WebA_\" + window.location.pathname;\n  }\n  updateJsonLd() {\n    const w = window;\n    const data = w.generatedJsonStructure || {};\n    document.querySelectorAll(\"[data-json-path]\").forEach((input) => {\n      const key = input.dataset.jsonPath;\n      if (key) {\n        data[key] = input.value;\n      }\n    });\n    document.querySelectorAll('[type=\"radio\"]:checked').forEach((radio) => {\n      data[radio.name] = radio.value;\n    });\n    document.querySelectorAll(\"table.data-table.dynamic\").forEach((table) => {\n      const tableKey = table.dataset.tableKey;\n      if (tableKey) {\n        const rows = [];\n        table.querySelectorAll(\"tbody tr\").forEach((tr) => {\n          const rowData = {};\n          let hasVal = false;\n          tr.querySelectorAll(\"[data-base-key]\").forEach((input) => {\n            if (input.type === \"checkbox\") {\n              rowData[input.dataset.baseKey] = input.checked;\n              if (input.checked)\n                hasVal = true;\n            } else {\n              rowData[input.dataset.baseKey] = input.value;\n              if (input.value)\n                hasVal = true;\n            }\n          });\n          if (hasVal)\n            rows.push(rowData);\n        });\n        data[tableKey] = rows;\n      }\n    });\n    const scriptBlock = document.getElementById(\"json-ld\");\n    if (scriptBlock) {\n      scriptBlock.textContent = JSON.stringify(data, null, 2);\n    }\n    const debugBlock = document.getElementById(\"json-debug\");\n    if (debugBlock) {\n      debugBlock.textContent = JSON.stringify(data, null, 2);\n    }\n    return data;\n  }\n  saveToLS() {\n    const data = this.updateJsonLd();\n    localStorage.setItem(this.formId, JSON.stringify(data));\n  }\n  restoreFromLS() {\n    const c = localStorage.getItem(this.formId);\n    if (!c)\n      return;\n    try {\n      const d = JSON.parse(c);\n      document.querySelectorAll(\"[data-json-path]\").forEach((input) => {\n        const key = input.dataset.jsonPath;\n        if (d[key] !== undefined)\n          input.value = d[key];\n      });\n      document.querySelectorAll(\"table.data-table.dynamic\").forEach((table) => {\n        const tableKey = table.dataset.tableKey;\n        const rowsData = d[tableKey];\n        if (Array.isArray(rowsData)) {\n          const tbody = table.querySelector(\"tbody\");\n          if (!tbody)\n            return;\n          const currentRows = tbody.querySelectorAll(\".template-row\");\n          rowsData.forEach((rowData, idx) => {\n            let row;\n            if (idx === 0) {\n              row = tbody.querySelector(\".template-row\");\n            } else {\n              const tmpl = tbody.querySelector(\".template-row\");\n              if (tmpl) {\n                row = tmpl.cloneNode(true);\n                row.classList.remove(\"template-row\");\n                const rmBtn = row.querySelector(\".remove-row-btn\");\n                if (rmBtn)\n                  rmBtn.style.visibility = \"visible\";\n                tbody.appendChild(row);\n              }\n            }\n            if (row) {\n              row.querySelectorAll(\"input, select\").forEach((input) => {\n                const k = input.dataset.baseKey;\n                if (k && rowData[k] !== undefined) {\n                  if (input.type === \"checkbox\")\n                    input.checked = !!rowData[k];\n                  else\n                    input.value = rowData[k];\n                }\n              });\n            }\n          });\n        }\n      });\n    } catch (e) {\n      console.error(e);\n    }\n  }\n  clearData() {\n    if (confirm(\"Clear all saved data? / 保存されたデータを削除しますか？\")) {\n      localStorage.removeItem(this.formId);\n      location.reload();\n    }\n  }\n  bakeValues() {\n    this.updateJsonLd();\n    document.querySelectorAll(\"input, textarea, select\").forEach((el) => {\n      if (el.closest(\".template-row\"))\n        return;\n      if (el.type === \"checkbox\" || el.type === \"radio\") {\n        if (el.checked)\n          el.setAttribute(\"checked\", \"checked\");\n        else\n          el.removeAttribute(\"checked\");\n      } else {\n        el.setAttribute(\"value\", el.value);\n        if (el.tagName === \"TEXTAREA\")\n          el.textContent = el.value;\n      }\n    });\n  }\n  downloadHtml(filenameSuffix, isFinal) {\n    const w = window;\n    const htmlContent = document.documentElement.outerHTML;\n    const blob = new Blob([htmlContent], { type: \"text/html\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    const title = w.generatedJsonStructure && w.generatedJsonStructure.name || \"web-a-form\";\n    const now = new Date;\n    const dateStr = now.getFullYear() + (\"0\" + (now.getMonth() + 1)).slice(-2) + (\"0\" + now.getDate()).slice(-2) + \"-\" + (\"0\" + now.getHours()).slice(-2) + (\"0\" + now.getMinutes()).slice(-2);\n    const randomId = Math.random().toString(36).substring(2, 8);\n    const filename = `${title}_${dateStr}_${filenameSuffix}_${randomId}.html`;\n    a.download = filename;\n    a.click();\n    if (isFinal) {\n      setTimeout(() => location.reload(), 1000);\n    }\n  }\n  saveDraft() {\n    this.bakeValues();\n    this.downloadHtml(\"draft\", false);\n  }\n  submitDocument() {\n    this.bakeValues();\n    document.querySelectorAll(\".search-suggestions\").forEach((el) => el.remove());\n    this.downloadHtml(\"submit\", true);\n  }\n}\n\n// src/weba/client/ui.ts\nclass UIManager {\n  calc;\n  data;\n  constructor(calc, data) {\n    this.calc = calc;\n    this.data = data;\n  }\n  applyI18n() {\n    const RESOURCES = {\n      en: {\n        add_row: \"+ Add Row\",\n        work_save_btn: \"Save Draft\",\n        submit_btn: \"Submit\",\n        clear_btn: \"Clear Data\"\n      },\n      ja: {\n        add_row: \"+ 行を追加\",\n        work_save_btn: \"作業保存\",\n        submit_btn: \"提出\",\n        clear_btn: \"クリア\"\n      }\n    };\n    const lang = (navigator.language || \"en\").startsWith(\"ja\") ? \"ja\" : \"en\";\n    const dict = RESOURCES[lang] || RESOURCES[\"en\"];\n    document.querySelectorAll(\"[data-i18n]\").forEach((el) => {\n      const key = el.dataset.i18n;\n      if (dict[key])\n        el.textContent = dict[key];\n    });\n  }\n  initTables() {\n    document.querySelectorAll(\".data-table.dynamic tbody\").forEach((tbody) => {\n      this.renumberRows(tbody);\n    });\n  }\n  renumberRows(tbody) {\n    const rows = tbody.querySelectorAll(\"tr\");\n    rows.forEach((row, index) => {\n      const num = index + 1;\n      row.querySelectorAll(\".auto-num\").forEach((input) => {\n        if (input.value != num) {\n          input.value = num.toString();\n          input.dispatchEvent(new Event(\"input\", { bubbles: true }));\n        }\n      });\n    });\n  }\n  removeTableRow(btn) {\n    const tr = btn.closest(\"tr\");\n    const tbody = tr.parentElement;\n    if (tr.classList.contains(\"template-row\")) {\n      tr.querySelectorAll(\"input\").forEach((inp) => {\n        if (inp.type === \"checkbox\")\n          inp.checked = false;\n        else\n          inp.value = \"\";\n      });\n    } else {\n      tr.remove();\n      if (tbody)\n        this.renumberRows(tbody);\n      this.calc.recalculate();\n      this.data.updateJsonLd();\n    }\n  }\n  addTableRow(btn, tableKey) {\n    const table = document.getElementById(\"tbl_\" + tableKey);\n    if (!table)\n      return;\n    const tbody = table.querySelector(\"tbody\");\n    if (!tbody)\n      return;\n    const templateRow = tbody.querySelector(\".template-row\");\n    if (!templateRow)\n      return;\n    const newRow = templateRow.cloneNode(true);\n    newRow.classList.remove(\"template-row\");\n    newRow.querySelectorAll(\"input\").forEach((input) => {\n      if (input.type === \"checkbox\") {\n        input.checked = input.hasAttribute(\"checked\");\n      } else {\n        input.value = input.getAttribute(\"value\") || \"\";\n      }\n    });\n    const rmBtn = newRow.querySelector(\".remove-row-btn\");\n    if (rmBtn)\n      rmBtn.style.visibility = \"visible\";\n    newRow.querySelectorAll(\"[data-copy-from]\").forEach((target) => {\n      const srcKey = target.dataset.copyFrom;\n      if (srcKey) {\n        const src = newRow.querySelector(`[data-base-key=\"${srcKey}\"]`);\n        if (src && src.value) {\n          target.value = src.value;\n        }\n      }\n    });\n    tbody.appendChild(newRow);\n    this.renumberRows(tbody);\n    this.calc.recalculate();\n  }\n  switchTab(btn, tabId) {\n    document.querySelectorAll(\".tab-btn\").forEach((b) => b.classList.remove(\"active\"));\n    document.querySelectorAll(\".tab-content\").forEach((c) => c.classList.remove(\"active\"));\n    btn.classList.add(\"active\");\n    const content = document.getElementById(tabId);\n    if (content)\n      content.classList.add(\"active\");\n  }\n}\n\n// src/weba/client/runtime.ts\nfunction initRuntime() {\n  console.log(\"Web/A Runtime Booting...\");\n  const calc = new Calculator;\n  const data = new DataManager;\n  const ui = new UIManager(calc, data);\n  const w = window;\n  w.saveDraft = () => data.saveDraft();\n  w.submitDocument = () => data.submitDocument();\n  w.clearData = () => data.clearData();\n  w.removeTableRow = (btn) => ui.removeTableRow(btn);\n  w.addTableRow = (btn, tableKey) => ui.addTableRow(btn, tableKey);\n  w.switchTab = (btn, tabId) => ui.switchTab(btn, tabId);\n  w.recalculate = () => calc.recalculate();\n  w.escapeHtml = (str) => {\n    if (!str)\n      return \"\";\n    const map = {\n      \"&\": \"&amp;\",\n      \"<\": \"&lt;\",\n      \">\": \"&gt;\",\n      '\"': \"&quot;\",\n      \"'\": \"&#39;\"\n    };\n    return str.toString().replace(/[&<>\"']/g, (m) => map[m] || m);\n  };\n  data.restoreFromLS();\n  ui.applyI18n();\n  ui.initTables();\n  calc.recalculate();\n  let tm;\n  document.addEventListener(\"input\", (e) => {\n    const input = e.target;\n    if (e.isTrusted) {\n      input.dataset.dirty = \"true\";\n    }\n    const key = input.dataset.baseKey || input.dataset.jsonPath;\n    if (key) {\n      const row = input.closest(\"tr\");\n      const scope = row || document;\n      scope.querySelectorAll(`[data-copy-from=\"${key}\"]`).forEach((dest) => {\n        if (!dest.dataset.dirty) {\n          if (dest.value !== input.value) {\n            dest.value = input.value;\n            dest.dispatchEvent(new Event(\"input\"));\n          }\n        }\n      });\n    }\n    calc.recalculate();\n    data.updateJsonLd();\n    clearTimeout(tm);\n    tm = setTimeout(() => data.saveToLS(), 1000);\n  });\n  console.log(\"Web/A Runtime Ready.\");\n}\n\n// src/weba/client/search.ts\nclass SearchEngine {\n  suggestionsVisible = false;\n  activeSearchInput = null;\n  globalBox = null;\n  constructor() {}\n  init() {\n    console.log(\"Initializing Search Engine (Bundle)...\");\n    const w = window;\n    if (w.generatedJsonStructure && w.generatedJsonStructure.masterData) {\n      const keys = Object.keys(w.generatedJsonStructure.masterData);\n      console.log(\"Master Data Keys available:\", keys.join(\", \"));\n    }\n    this.setupEventDelegation();\n  }\n  normalize(val) {\n    if (!val)\n      return \"\";\n    let n = val.toString().toLowerCase();\n    n = n.replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) => {\n      return String.fromCharCode(s.charCodeAt(0) - 65248);\n    });\n    n = n.replace(/[！-～]/g, (c) => String.fromCharCode(c.charCodeAt(0) - 65248));\n    return n.trim();\n  }\n  clean(s) {\n    if (!s)\n      return \"\";\n    let n = this.normalize(s);\n    n = n.replace(/(株式会社|有限会社|合同会社|一般社団法人|公益社団法人|npo法人|学校法人|社会福祉法人)/g, \"\");\n    n = n.replace(/(\\(株\\)|\\(有\\)|\\(同\\))/g, \"\");\n    return n.trim();\n  }\n  toIndex(raw) {\n    const parsed = parseInt(raw || \"\", 10);\n    return Number.isFinite(parsed) ? parsed - 1 : -1;\n  }\n  getGlobalBox() {\n    if (!this.globalBox) {\n      this.globalBox = document.getElementById(\"web-a-search-suggestions\");\n      if (!this.globalBox) {\n        this.globalBox = document.createElement(\"div\");\n        this.globalBox.id = \"web-a-search-suggestions\";\n        this.globalBox.className = \"search-suggestions\";\n        Object.assign(this.globalBox.style, {\n          display: \"none\",\n          position: \"absolute\",\n          background: \"white\",\n          border: \"1px solid #ccc\",\n          boxShadow: \"0 4px 6px rgba(0,0,0,0.1)\",\n          zIndex: \"9999\",\n          maxHeight: \"200px\",\n          overflowY: \"auto\",\n          borderRadius: \"4px\"\n        });\n        document.body.appendChild(this.globalBox);\n      }\n    }\n    return this.globalBox;\n  }\n  hideSuggestions() {\n    const box = this.getGlobalBox();\n    if (box)\n      box.style.display = \"none\";\n    this.suggestionsVisible = false;\n    this.activeSearchInput = null;\n  }\n  setupEventDelegation() {\n    document.addEventListener(\"click\", (e) => {\n      if (this.suggestionsVisible && !e.target.closest(\"#web-a-search-suggestions\") && e.target !== this.activeSearchInput) {\n        this.hideSuggestions();\n      }\n    });\n    document.addEventListener(\"scroll\", () => {\n      if (this.suggestionsVisible)\n        this.hideSuggestions();\n    }, true);\n    document.body.addEventListener(\"input\", (e) => {\n      if (e.target.classList.contains(\"search-input\")) {\n        this.handleSearchInput(e.target);\n      }\n    });\n    document.body.addEventListener(\"click\", (e) => {\n      if (e.target.classList.contains(\"suggestion-item\")) {\n        this.handleSelection(e.target);\n      }\n    });\n  }\n  handleSearchInput(input) {\n    this.activeSearchInput = input;\n    const w = window;\n    const srcKey = input.dataset.masterSrc;\n    const suggestSource = input.dataset.suggestSource;\n    if (!srcKey && !suggestSource)\n      return;\n    const labelIdx = this.toIndex(input.dataset.masterLabelIndex);\n    const valueIdx = this.toIndex(input.dataset.masterValueIndex);\n    const query = input.value;\n    if (!query) {\n      this.hideSuggestions();\n      return;\n    }\n    const hits = [];\n    const normQuery = this.normalize(query);\n    if (suggestSource === \"column\") {\n      const baseKey = input.dataset.baseKey;\n      const table = input.closest(\"table\");\n      if (table && baseKey) {\n        const seen = new Set;\n        table.querySelectorAll(`[data-base-key=\"${baseKey}\"]`).forEach((inp) => {\n          if (inp === input)\n            return;\n          const v = inp.value;\n          if (v && this.normalize(v).includes(normQuery)) {\n            if (!seen.has(v)) {\n              seen.add(v);\n              hits.push({ val: v, row: [v], label: v, score: 10 });\n            }\n          }\n        });\n      }\n    } else if (srcKey) {\n      const master = w.generatedJsonStructure.masterData;\n      if (!master || !master[srcKey])\n        return;\n      const allRows = master[srcKey];\n      allRows.forEach((row, idx) => {\n        if (idx === 0)\n          return;\n        const match = row.some((col) => this.normalize(col || \"\").includes(normQuery));\n        if (match) {\n          const labelVal = labelIdx >= 0 ? row[labelIdx] || \"\" : \"\";\n          const valueVal = valueIdx >= 0 ? row[valueIdx] || \"\" : \"\";\n          const val = valueIdx >= 0 ? valueVal : labelIdx >= 0 ? labelVal : row[1] || row[0] || \"\";\n          hits.push({ val, row, label: labelVal, score: 10, idx });\n        }\n      });\n    }\n    this.renderSuggestions(input, hits, labelIdx);\n  }\n  renderSuggestions(input, hits, labelIdx) {\n    if (hits.length === 0) {\n      this.hideSuggestions();\n      return;\n    }\n    const w = window;\n    const topHits = hits.slice(0, 10);\n    let html = \"\";\n    topHits.forEach((h) => {\n      const rowJson = w.escapeHtml(JSON.stringify(h.row));\n      const displayLabel = labelIdx >= 0 ? h.label || h.row.join(\" : \") : h.row.join(\" : \");\n      html += `<div class=\"suggestion-item\" data-val=\"${w.escapeHtml(h.val)}\" data-row=\"${rowJson}\" style=\"padding:8px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; color:#333;\">${w.escapeHtml(displayLabel)}</div>`;\n    });\n    const box = this.getGlobalBox();\n    box.innerHTML = html;\n    const rect = input.getBoundingClientRect();\n    const scrollTop = window.scrollY || document.documentElement.scrollTop;\n    const scrollLeft = window.scrollX || document.documentElement.scrollLeft;\n    box.style.width = Math.max(rect.width, 200) + \"px\";\n    box.style.left = rect.left + scrollLeft + \"px\";\n    box.style.top = rect.bottom + scrollTop + \"px\";\n    box.querySelectorAll(\".suggestion-item\").forEach((el) => {\n      el.onmouseenter = () => el.style.background = \"#f0f8ff\";\n      el.onmouseleave = () => el.style.background = \"white\";\n    });\n    box.style.display = \"block\";\n    this.suggestionsVisible = true;\n  }\n  handleSelection(item) {\n    if (!this.activeSearchInput)\n      return;\n    const w = window;\n    const input = this.activeSearchInput;\n    const val = item.dataset.val || \"\";\n    const rowJson = item.dataset.row || \"[]\";\n    try {\n      const rowData = JSON.parse(rowJson);\n      const srcKey = input.dataset.masterSrc;\n      const masterHeaders = srcKey ? w.generatedJsonStructure.masterData[srcKey][0] : [];\n      let searchInputFilled = false;\n      if (masterHeaders.length > 0 && rowData.length > 0) {\n        const tr = input.closest(\"tr\");\n        if (tr) {\n          const inputs = Array.from(tr.querySelectorAll(\"input, select, textarea\"));\n          masterHeaders.forEach((header, idx) => {\n            if (!header)\n              return;\n            const targetVal = rowData[idx];\n            this.fillField(inputs, header, targetVal, input, () => {\n              searchInputFilled = true;\n            });\n          });\n        }\n      }\n      if (!searchInputFilled) {\n        input.value = val;\n        input.dispatchEvent(new Event(\"input\", { bubbles: true }));\n      }\n    } catch (e) {\n      console.error(e);\n    }\n    this.hideSuggestions();\n  }\n  fillField(inputs, header, value, sourceInput, onSelfFilled) {\n    const normHeader = this.normalize(header);\n    const target = inputs.find((inp) => {\n      const k = inp.dataset.baseKey || inp.dataset.jsonPath;\n      const ph = this.normalize(inp.getAttribute(\"placeholder\") || \"\");\n      return k && this.normalize(k) === normHeader || ph === normHeader;\n    });\n    if (target) {\n      target.value = value || \"\";\n      target.dispatchEvent(new Event(\"input\", { bubbles: true }));\n      if (target === sourceInput)\n        onSelfFilled();\n    }\n  }\n}\n\n// src/weba/client/index.ts\nvar search = new SearchEngine;\nwindow.GlobalSearch = search;\ninitRuntime();\nsearch.init();\n";
