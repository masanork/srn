---
title: "既知の問題と今後の検討事項"
layout: article
description: "本PoCにおける技術的な制約、暫定的な仕様決定、および将来のPQC VC実用化に向けた議論点のまとめ。"
font: ipamjm.ttf,acgjm.ttf
---

本文書は、SRNプロジェクトのバージョン1.0.0（PoC: 概念実証）段階における技術的な制約、一時的な設計判断、および標準化が未確定な領域についてまとめています。
将来的に本システムを商用・実運用レベルのポスト量子暗号（PQC）Verifiable Credentialシステムへ移行させるための、開発チーム向けロードマップ資料として活用します。

## 1. トラストアーキテクチャ (Trust Architecture)

### ルート鍵の管理 (Key Hygiene)
*   **現状**: ルートID鍵（Root Key）は、ビルドサーバー（ローカルディスク）上の平文JSONファイル (`site/data/root-key.json`) として保存されています。
*   **リスク**: ビルド環境が侵害された場合、ルート鍵が漏洩し、すべての信頼チェーンが崩壊します。
*   **実運用要件**:
    *   **HSM/KMS**: ルート鍵はHardware Security Module (HSM) やクラウドのKMSで生成・管理されるべきです。
    *   **オフラインルート**: ルート鍵は普段はオフラインで保管し、ビルドごとの「発行鍵（Issuing Key）」への署名（Delegation）にのみ使用する運用が理想的です。

### ビルドごとの使い捨て鍵 (Ephemeral Keys) とDID
*   **現状**: ビルドのたびに新しい `did:key` を生成しています。
*   **課題**: これにより「発行者（Issuer）」が無数に発生します。独自仕様の `status-list` でルート鍵との紐付けを行っていますが、標準的なDIDリゾルバはこの「ビルド鍵→ルート鍵」の関係を解決できません。
*   **検討事項**: `did:web` (例: `did:web:srn.example.com`) の採用を検討すべきです。公開鍵を特定のURLで公開・ローテーションする方式の方が、今回のような運用には適している可能性があります。

### トラストモデルの選定と将来展望 (Trust Model Anchor)
*   **現状の決定**: 当面の実装として、**WebPKI (TLS/HTTPS)** に依存するモデルを採用しました。
    *   **理由**: SSG環境において、最終的な信頼の基点（Trust Anchor）をドメイン名（DNS）とそれを保護するサーバー証明書に置くこと（`did:web` 的なアプローチ）が、コストとデプロイ容易性の観点で最も現実的であるためです。
*   **議論された他の選択肢**:
    *   **GPKI (政府認証基盤) とのブリッジ**: 日本政府のGPKI（Government Generic PKI）とSRNのルート鍵を相互認証させる、あるいはブリッジ認証局を介して接続する案。行政文書としての正当性を法的に担保するには理想的ですが、技術的なインターフェースの複雑さと制度的なハードルが高いため、今回のPoCでは対象外としました。
    *   **GPKInado (汎用公開鍵基盤)**: よりオープンなPKI構造との連携も視野に入れましたが、まずはWebPKIの上で完結する設計を優先しました。
*   **今後の検討**: 公的個人認証サービス（JPKI）や、eシール（e-Seal）を扱う認定トラストサービス事業者（TSP）と連携し、SRNが発行するVCにそれらの外部署名を付与する「多重署名モデル」を模索します。

## 2. 失効管理 (Revocation)

### Status List 2021 (Bitstring) への準拠
*   **現状**: 標準のビットストリング方式 (`encodedList`) ではなく、単純なJSON配列（`revokedBuildIds`）による独自リスト・独自プロファイルを採用しています。
*   **理由**: 静的サイトジェネレーターにおいて、全VCへのインデックス割り当てやビット列の状態管理（DB）を行うのはオーバーヘッドが大きすぎると判断したためです。
*   **制約**: 汎用的な Status List 2021 検証器とは相互運用性がありません。
*   **今後の対応**: 完全な相互運用性が必要な場合は、VC発行時にユニークなインデックスを割り当てて管理する台帳DBの実装が必要です。

### 失効の粒度
*   **現状**: 「ビルド単位」での失効のみサポートしています。ある鍵を失効させると、そのビルドで生成された全文書が無効になります。
*   **課題**: 特定の文書（例: 「戸籍証明書 No.1」だけ）をピンポイントで失効させることができません。
*   **検討事項**: 文書ごとの詳細な失効が必要な場合、文書ごとにユニークIDを採番し、より大規模なStatus Listを運用する必要があります。

## 3. フォーマットと相互運用性

### JSON-LD Context
*   **現状**: SRN独自の用語（`srn:revokedBuildIds` 等）について、オンラインの `@context` 定義ファイルをホストしていません。
*   **課題**: 厳密なJSON-LD仕様としては、コンテキスト定義のない用語は無視されるかエラーになります。
*   **今後の対応**: `https://srn.org/ns/v1` のようなURLで `context.json` を公開し、用語定義を行う必要があります。

### JCS (JSON Canonicalization)
*   **現状**: 正規化に RFC 8785 (JCS) を採用しています。
*   **検討事項**: 分散型ID（DID）周辺では RDF Dataset Normalization (URDNA2015) が使われることも多いです。JCSで良いか、ターゲットとするエコシステム（EUDI Wallet等）の要件を確認する必要があります。

## 4. 法的・制度的位置付けと署名の性質

### 電子署名とeシール (Electronic Signature vs e-Seal)
*   **現状の整理**: 本システムがVCに付与する署名は、技術的には「デジタル署名」ですが、電子署名法上の「電子署名（自然人の意思表示）」として整理すべきか、あるいはEU eIDAS規則等にある「eシール（法人・組織の発行元証明・非改竄証明）」として整理すべきかという論点があります。
*   **本システムの立ち位置**: SRNはビルドプロセス（CI/CD等）において自動的に署名を生成します。したがって、これは特定個人のその瞬間の意思を表すものではなく、**「組織（またはノード）が正当な手続きで発行した真正なデータであること」を保証するeシール**としての性格が強いと解釈しています。

### 検証可能性と「意思」の乖離
*   **共通の課題**: この「署名はなされているが、必ずしも自然人の意思が介在しているわけではない」という点は、WebPKI（自動更新されるTLS証明書）や、GPKIにおける官職証明書（職責に基づく自動発行システム等）にも共通する構造的な課題です。
*   **本PoCの結論**: 検証可能性（Verifiability）とは「誰が（何が）発行したか」と「改竄されていないか」を暗号学的に担保することであり、本システムではその点にフォーカスしています。「文書の内容に対する同意（意思）」を法的に担保する必要がある場合は、別途、自然人によるJPKI署名等をペイロードに含める（多重署名）設計が必要となります。

## 5. Holder BindingとWalletの課題

### 公示機能と本人性の乖離
*   **現状の制約**: 本システムは現在、VC（Verifiable Credential）の発行と検証のみを実装しています。これは「公示された情報の真正性」を証明するには十分ですが、「その証明書の正当な持ち主であること」を証明する機能（**Holder Binding**）を有していません。
*   **リスク**: 戸籍や住民票のように、特定の個人に対して発行される証明書の場合、他人のVCファイルをコピーして提示（なりすまし）されるリスクがあります。これを防ぐには、提示者（Holder）が自身の秘密鍵で署名して提出する **Verifiable Presentation (VP)** の仕組みが必須となります。

### ブラウザ環境でのWallet実装の難しさ
*   **課題**: VPを生成するためには、ユーザー（Holder）が自身の秘密鍵を安全に管理し、署名を行う機能（**Wallet**）が必要です。しかし、SRNはWebブラウザ（クライアントサイドJavaScript）で完結する検証・閲覧環境を前提としており、以下の課題があります。
    *   **鍵管理**: ブラウザの `localStorage` 等に秘密鍵を保存するのはセキュリティ上脆弱です。
    *   **UX**: 一般ユーザーに専用のネイティブアプリ（Walletアプリ）のインストールを求めるのはハードルが高いです。
*   **今後の検討**:
    *   **WebAuthn / Passkeys**: FIDO2認証器（TouchID/FaceID等）内の鍵を利用して、ブラウザ標準機能だけでVP署名を行うアプローチ。
    *   **Cloud Wallet**: 鍵管理を信頼できるサーバーサイド（クラウド）に委任し、認証後に署名させる方式。
    *   **OWDI (Open Wallet Foundation)**: ブラウザ上で動作する軽量なWallet標準の策定動向を注視します。

## 6. 長期署名とSSGの特性 (Long-term Validation)

### 再署名 (Resigning) による「Active Refresh」モデル
*   **従来の課題**: 一般的な電子文書の長期保存（e-文書法対応など）では、暗号アルゴリズムの危殆化に対応するため、定期的に新たなタイムスタンプで署名を包み込んでいく（アーカイブタイムスタンプ / ES-Aフォーマット等）必要があり、検証ロジックが年々複雑化するという課題があります。
*   **SRNの可能性**: 静的サイトジェネレーター（SSG）であるSRNは、コンテンツ（Markdown）が正である限り、**ビルドのたびに最新・最強の暗号アルゴリズムと鍵で「再署名」し直す**ことが容易です。
    *   これにより、過去の署名検証ロジックを引きずる必要がなくなり、検証者は常に「現在の最新基準」だけで検証すれば良くなります。これはデジタルアーカイブのメンテナンスコストを劇的に下げる可能性があります。

### タイムスタンプ (TSA) の必要性
*   **現状の制約**: 現在の署名時刻はシステム時刻による自己申告です。
*   **検討事項**: 「ある時点でその文書が存在したこと」を第三者的に証明するには、RFC 3161準拠のタイムスタンプ局（TSA）からトークンを取得し、VCに埋め込む仕組みが必要です。
    *   SRNのビルドパイプラインに「認定TSAへのリクエスト」を組み込むことで、**「最新の暗号で再署名され、かつ確定日時はオリジナルのTSAで保証される」** というハイブリッドな長期保存モデルが構築できる可能性があります。

## 7. プライバシーとデータ配信 (Privacy & Delivery)

### 静的配信モデルと個人情報保護
*   **現状の課題**: 現在のSRNのアーキテクチャでは、生成されたすべてのアーティファクト（HTML, VC JSON）が `dist/` ディレクトリに出力され、Webサーバー上で公開状態になることを前提としています。これは「広報」や「法令」の公示には適していますが、今回のサンプルのような「戸籍」や「成績証明書」といった機微な個人情報を含む文書を扱う場合、重大なプライバシー侵害リスクとなります。
*   **必要な対策**:
    *   **アクセス制御 (AuthN/AuthZ)**: 生成されたVCの実体ファイルを、認証済みユーザーのみがアクセス可能なストレージ（Intranet、S3の署名付きURL、Basic認証配下など）に配置するデプロイメント設計が必要です。
    *   **ハイブリッド構成**: すべてを事前に静的生成（SSG）するのではなく、個人情報部分はリクエスト時にオンデマンドで生成・署名して返すAPIサーバー機能（SSR/ISR的アプローチ）との組み合わせを検討する必要があります。
*   **Selective Disclosureへの接続**: 適切なアクセス制御で本人にデータを渡せたとしても、本人がそれを第三者に提示する際に「すべて見せてしまう」リスクは残ります。そこで初めて、次章の「Selective Disclosure（選択的開示）」技術が重要になります。

## 8. 表現力と機械可読性の両立 (Typography & Data Structure)

### Webベース文書における文字ハンドリングの課題
*   **PDFとの比較**: PDFはフォント（グリフ）をドキュメント内に固定的に埋め込むため、どのような環境でも意図した通りの「字形」が表示されます（見読性の保証）。一方、通常のWeb（HTML）はクライアント端末のフォント環境に依存するため、人名や地名などの厳密な異体字（IVS/SVS）や、Unicode未割当の外字が正しく表示されないリスクが常にあります。
*   **SRNのアプローチ**: 本システムでは以下の手法により、PDFと同等の見読性と、HTMLならではの機械可読性の両立を図っています。
    *   **サブセットWebフォント**: ページ内で使用されている文字だけを抽出したフォントファイルを動的に生成し、Data URIとしてHTMLに直接埋め込むことで、外部リクエストなしに正確な字形表示を保証しています。
    *   **SVGグリフ埋め込み**: Unicode符号位置が割り当てられていない文字（外字）や、特定のフォントデザインが必須な文字については、フォントデータからベクターデータ（SVGパス）を抽出し、画像として埋め込む仕組みを実装しました。

### 機械可読性とSelective Disclosure
*   **Hybrid Documentモデル**: SRNは「人間が見るためのHTML」と「機械が読むためのJSON-LD (VC)」をセットで生成・署名するモデルを採用しています。これにより、レイアウトの美しさとデータ処理の容易さを両立しています。
*   **今後の検討 (Massive Data)**:
    *   **Selective Disclosure (SD)**: 戸籍のように項目数が膨大で、かつ「一部の項目（例えば特定の家族の情報だけ）を開示したい」というニーズがある場合、現在の単純なJSON-LD署名では対応できません（全開示か全非公開かの二択）。
    *   **技術選定**: 今後、**SD-JWT (IETF)** や **BBS+ Signatures (Zero-Knowledge Proofs)** といった、選択的開示を可能にする新しい署名フォーマットの採用を検討する必要があります。ただし、これらはデータ構造が複雑化するため、SSGとしての「単純さ・堅牢さ」とのトレードオフを慎重に見極める必要があります。

---

## 9. 暗号アルゴリズムの選定とPQC (Cryptography & PQC)

### 従来型アルゴリズムの比較と選定理由
*   **Ed25519 (EdDSA) の採用理由**:
    *   **安全性**: 署名生成時に乱数（Nonce）を必要とせず、決定論的に署名を生成するため、乱数生成器の不具合による秘密鍵漏洩リスク（ECDSAの脆弱性）がありません。
    *   **パフォーマンス**: RSAや従来のECDSAに比べて署名・検証速度が非常に高速で、ビルド時間の短縮に寄与します。
    *   **VCエコシステム**: W3C Verifiable Credentials界隈では事実上のデファクトスタンダード (`Ed25519Signature2020` 等) であり、ライブラリのサポートも手厚いため採用しました。
*   **RSA (現在のJPKI/GPKI)**:
    *   **課題**: 鍵長が長く（2048/4096 bit）、VCのサイズが肥大化します。また、計算コストも高いため、大量のVCを発行する本システムのユースケースでは効率が悪いです。
*   **ECDSA (P-256) (政府システムの移行先)**:
    *   **課題**: 日本政府のガイドライン等ではRSAからの移行先として推奨されていますが、署名時に高品質な乱数を必要とするため、実装難易度（サイドチャネル攻撃への対策等）がEdDSAより高くなります。
    *   **対応**: ただし、既存のICカード（マイナンバーカード等）との互換性を重視する場合は、将来的にECDSA (`EcdsaSecp256r1Signature2019`) のサポートが必要になる可能性があります。

### ML-DSA (Dilithium) の標準化状況
*   **現状**: `@noble/post-quantum/ml-dsa.js` ライブラリを使用し、**FIPS 204 (Draft)** 仕様に基づき実装しています。
*   **課題**: FIPS 204の最終版（Final）では、OID（オブジェクト識別子）の割り当てやシリアライズ形式が変更され、現在のDraft版と互換性がなくなる可能性があります。
*   **今後の対応**: NISTおよびIETFの動向を継続的に監視する必要があります。現在使用している `cryptosuite: "ml-dsa-44-2025"` は本プロジェクト独自の実験的な識別子であり、公式な標準ではありません。

### ハイブリッド署名スキーム
*   **現状**: Ed25519（既存ECC）とML-DSA（PQC）の署名を、VCの `proof` 配列に独立した2つの署名として格納する方式をとっています。
*   **課題**: 「ハイブリッド検証方式」に関する標準仕様（例: 1つのDID KeyオブジェクトにECCとPQC両方の鍵を含める方法や、結合署名フォーマットなど）はまだ確立されていません。
*   **リスク**: 検証器の実装によっては、最初のEd25519署名だけを見て検証完了としたり、未知のPQCスイートを見てエラーとする可能性があります。

## 10. 次世代標準スタックの検討 (Proposed Architecture)

AIアシスタント（ChatGPT）より提案された、より標準的かつ将来性の高い技術スタック案についての検討と、SRNでの適用可能性についての分析です。

### 提案されたスタック
| レイヤ | 採用規格 | 状態 | SRNにおける評価 |
| :--- | :--- | :--- | :--- |
| **VCモデル** | W3C Verifiable Credentials | 勧告 | **採用中** (v1.1/v2.0へ追従が必要) |
| **VC保護** | **COSE / JOSE** | WG仕様 | **要検討**: 現在のJSON-LD Proofsからの移行先として有力。 |
| **署名器** | **COSE_Sign1** | RFC | **要検討**: バイナリ形式(CBOR)によるサイズ削減とハードウェア親和性。 |
| **PQC署名** | ML-DSA (Dilithium) | NIST/IETF | **採用中**: PoC実装済み。 |
| **鍵解決** | **did:web** | 実運用可 | **推奨**: 本PoCの課題セクションでも結論付けた通り、最適解。 |
| **信頼根** | WebPKI (WebTrust) | 成熟 | **採用中**: システムの基盤として既に信頼している。 |
| **コンテンツ来歴** | **C2PA** | 業界標準 | **新規**: VCとは異なるレイヤーでの「表示」の真正性担保として有望。 |

### 分析と導入の方向性

#### 1. JSON-LD Proofs から JOSE/COSE への移行
*   **現状**: Web親和性とセマンティックウェブの文脈から `Linked Data Proofs` を採用しています。
*   **トレンド**: W3C VC Data Model v2.0 や EUDI Wallet (EUデジタルID) の流れでは、署名フォーマットとして **JOSE (JWS/JWT)** や **COSE (CWT)** を用いる「Enveloping（包み込み）」方式が主流になりつつあります。
*   **メリット**:
    *   **PQC対応**: 巨大なPQC署名を扱う際、CBOR (COSE) のようなバイナリ形式の方がデータサイズ効率が良い。
    *   **汎用性**: IANAレジストリ等で管理される標準的なアルゴリズムIDを使用するため、独自ライブラリへの依存が減る。

#### 2. C2PA (Content Credentials) の活用
*   **可能性**: VCは「データ（氏名、住所）」の真正性を証明しますが、C2PAは「コンテンツ（生成されたHTMLファイルや画像、PDF）」の来歴と非改竄を証明する技術です。
*   **SRNとの親和性**: 「見読性（Typography）」を重視するSRNにおいて、生成された**HTMLファイル自体にC2PAメタデータを埋め込む**ことで、ブラウザ上で「この表示自体が正しいこと」を検証可能にするアプローチは、VCと相互補完的な強力なソリューションになり得ます。

---
*本書は v1.0.0 時点での技術的負債およびアーキテクチャ上の決定事項を記録したものです。*

---
*本書は v1.0.0 時点での技術的負債およびアーキテクチャ上の決定事項を記録したものです。*
