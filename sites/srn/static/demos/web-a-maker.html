<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web/A Form Maker (Markdown)</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #f0f0f0;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
        }

        .pane-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #editor {
            flex: 1;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            font-size: 14px;
            line-height: 1.5;
        }

        #preview-container {
            flex: 1;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow-y: auto;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        /* Web/A Form Styles (Simplified) */
        .preview-content {
            max-width: 210mm;
            margin: 0 auto;
        }

        .form-row {
            display: flex;
            margin-bottom: 20px;
            align-items: center;
        }

        .form-row.vertical {
            display: block;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-right: 15px;
            min-width: 140px;
            /* Align horizontal labels */
        }

        .form-row.vertical .form-label {
            margin-bottom: 8px;
            width: 100%;
        }

        .form-input {
            flex: 1;
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .data-table th {
            background: #f9f9f9;
            font-weight: bold;
        }

        .add-row-btn {
            background: #eee;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .add-row-btn:hover {
            background: #ddd;
        }

        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
            text-align: center;
        }

        button.primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button.primary:hover {
            background: #0056b3;
        }

        .syntax-help {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            background: #eef;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>

<body>

    <div class="pane" style="border-right: 1px solid #ddd;">
        <div class="pane-header">
            <span>Markdown Definition</span>
            <button class="primary" onclick="downloadWebA()">Download Web/A Form</button>
        </div>
        <textarea id="editor" spellcheck="false" oninput="parseAndRender()"># 経費精算書

これはWeb/A FormのMarkdown定義サンプルです。
以下のようにリスト形式でフォーム部品を定義できます。

- [text:title] 件名
- [date:date] 発生日
- [number:amount] 金額 (円)
- [textarea:reason] 申請理由 (詳細)
- [radio:type] 経費種別
  - 交通費
  - 宿泊費
  - 接待交際費

---
(C) 2025 Sorane Corp.
</textarea>
        <div class="syntax-help">
            <strong>Syntax Guide:</strong><br>
            <code># Title</code> : Document Title<br>
            <code>- [type:key] Label</code> : Input Field (text, number, date, textarea)<br>
            <code>- [radio:key] Label</code> : Radio Group (Indented items become options)
        </div>
    </div>

    <div class="pane">
        <div class="pane-header">Preview</div>
        <div id="preview-container">
            <div id="preview" class="preview-content"></div>
        </div>
    </div>

    <script>
        // --- Parser & Renderer ---

        function parseAndRender() {
            const text = document.getElementById('editor').value;
            const preview = document.getElementById('preview');
            const lines = text.split('\n');

            let html = '';
            let jsonStructure = { "@context": "https://schema.org", "@type": "CreativeWork" };
            let currentRadioGroup = null;

            lines.forEach((line, index) => {
                const trimmed = line.trim();

                // 1. Headers
                if (trimmed.startsWith('# ')) {
                    const title = trimmed.substring(2);
                    html += `<h1>${escapeHtml(title)}</h1>`;
                    jsonStructure.name = title;
                    currentRadioGroup = null;
                }
                // 2. Form Components (List items)
                else if (trimmed.startsWith('- [')) {
                    // Regex to match: - [type:key] Label
                    const match = trimmed.match(/^-\s*\[([a-z]+):([a-zA-Z0-9_]+)\]\s*(.*)$/);
                    if (match) {
                        const [_, type, key, label] = match;
                        currentRadioGroup = null;

                        if (type === 'radio') {
                            currentRadioGroup = { key, label, options: [] };
                            // We will render radio group after collecting options (next lines)
                            // But wait, we are iterating line by line.
                            // We need to look ahead or handle state. 
                            // Simplest: Render a placeholder or start a specific block.
                            // Let's defer rendering until we hit a non-option line or end.
                            // Actually, for simplicity in this PoC, let's output the opening tag now.
                            html += Renderers.radioStart(key, label);
                        } else if (Renderers[type]) {
                            html += Renderers[type](key, label);
                        } else {
                            html += `<p style="color:red">Unknown type: ${type}</p>`;
                        }
                    } else {
                        // Maybe valid list but not our syntax? Just render as list text for now?
                        // Or check for radio options (indented)
                    }
                }
                // 3. Radio Options (Indented)
                else if (line.startsWith('  - ') || line.startsWith('\t- ')) {
                    if (currentRadioGroup) {
                        const label = trimmed.replace(/^-\s*/, '');
                        // Use label as value for simplicity in this text format
                        html += Renderers.radioOption(currentRadioGroup.key, label, label);
                    }
                }
                // 4. Horizontal Rule
                else if (trimmed.startsWith('---')) {
                    html += '<hr>';
                    currentRadioGroup = null;
                }
                // 5. Plain Paragraphs (if not empty)
                else if (trimmed.length > 0) {
                    // Close radio group div if we were in one?
                    if (currentRadioGroup) {
                        html += '</div></div>'; // Close radio-group and form-row
                        currentRadioGroup = null;
                    }
                    html += `<p>${escapeHtml(trimmed)}</p>`;
                }
                else {
                    // Empty line
                    if (currentRadioGroup) {
                        html += '</div></div>'; // Close radio-group and form-row
                        currentRadioGroup = null;
                    }
                }
            });

            // Final cleanup
            if (currentRadioGroup) {
                html += '</div></div>';
            }

            preview.innerHTML = html;
            window.generatedJsonStructure = jsonStructure;

            // Init tables in preview? No need, they are dynamic.
            // But for "Add Row" to work in Preview, we need the function in global scope.
        }

        const Renderers = {
            text: (key, label, attrs) => `
            <div class="form-row">
                <label class="form-label">${escapeHtml(label)}</label>
                <input type="text" class="form-input" data-json-path="${key}" style="${getStyle(attrs)}"${getExtraAttrs(attrs)}>
            </div>`,
            number: (key, label, attrs) => `
            <div class="form-row">
                <label class="form-label">${escapeHtml(label)}</label>
                <input type="number" class="form-input" data-json-path="${key}" style="${getStyle(attrs)}"${getExtraAttrs(attrs)}>
            </div>`,
            date: (key, label, attrs) => `
            <div class="form-row">
                <label class="form-label">${escapeHtml(label)}</label>
                <input type="date" class="form-input" data-json-path="${key}" style="${getStyle(attrs)}"${getExtraAttrs(attrs)}>
            </div>`,
            textarea: (key, label, attrs) => `
            <div class="form-row vertical">
                <label class="form-label">${escapeHtml(label)}</label>
                <textarea class="form-input" rows="5" data-json-path="${key}" style="${getStyle(attrs)}"${getExtraAttrs(attrs)}></textarea>
            </div>`,
            radioStart: (key, label, attrs) => `
            <div class="form-row vertical" style="${getStyle(attrs)}">
                <label class="form-label">${escapeHtml(label)}</label>
                <div class="radio-group" style="padding-left: 10px;">`,
            radioOption: (name, val, label, checked) => `
                <label style="display:block; margin-bottom:5px;">
                    <input type="radio" name="${name}" value="${escapeHtml(val)}" ${checked ? 'checked' : ''}> ${escapeHtml(label)}
                </label>`,
            // Static Table Row Renderer
            tableRow: (cells) => {
                const tds = cells.map(cell => {
                    const trimmed = cell.trim();
                    // Check if cell is an input definition: [key] or [key:attrs]
                    // Allowed: [item1], [price:size:S], or just plain text "Total"
                    const match = trimmed.match(/^\[([a-zA-Z0-9_]+)(?::([^\]]+))?\]$/);
                    if (match) {
                        const [_, key, attrs] = match;
                        return `<td><input type="text" class="form-input" data-json-path="${key}" style="${getStyle(attrs)}"${getExtraAttrs(attrs)}></td>`;
                    } else {
                        return `<td>${escapeHtml(trimmed)}</td>`;
                    }
                }).join('');
                return `<tr>${tds}</tr>`;
            }
        };

        function getStyle(attrs) {
            if (!attrs) return '';
            let style = '';
            if (attrs.includes('size:L')) style += 'font-size: 1.25em;';
            if (attrs.includes('size:S')) style += 'font-size: 0.8em;';
            if (attrs.includes('size:XL')) style += 'font-size: 1.5em; font-weight: bold;';
            if (attrs.includes('align:R')) style += 'text-align: right;';
            if (attrs.includes('align:C')) style += 'text-align: center;';
            return style;
        }

        function getExtraAttrs(attrs) {
            if (!attrs) return '';
            let extra = '';
            // Match len:N or max:N
            const lenMatch = attrs.match(/(?:len|max):(\d+)/);
            if (lenMatch) {
                extra += ` maxlength="${lenMatch[1]}"`;
            }

            // Match default value: val="xxx"
            // Note: Simple regex, assumes no quotes inside value for now
            const valMatch = attrs.match(/val="([^"]+)"/);
            if (valMatch) {
                extra += ` value="${escapeHtml(valMatch[1])}"`;
            } else {
                // Try without quotes for simple strings
                const valMatchSimple = attrs.match(/val=([^\s\)]+)/);
                if (valMatchSimple) {
                    extra += ` value="${escapeHtml(valMatchSimple[1])}"`;
                }
            }

            return extra;
        }

        // --- Parser Updated ---
        function parseAndRender() {
            const text = document.getElementById('editor').value;
            const preview = document.getElementById('preview');
            const lines = text.split('\n');

            let html = '';
            let jsonStructure = { "@context": "https://schema.org", "@type": "CreativeWork" };
            let currentRadioGroup = null;
            let inTable = false;

            lines.forEach((line, index) => {
                const trimmed = line.trim();

                // 0. Table Logic
                if (trimmed.startsWith('|')) {
                    if (!inTable) {
                        html += '<div class="form-row vertical"><table class="data-table"><tbody>';
                        inTable = true;
                    }
                    const cells = trimmed.split('|').slice(1, -1);
                    const isSeparator = cells.every(c => c.trim().match(/^-+$/));
                    if (!isSeparator) {
                        html += Renderers.tableRow(cells);
                    }
                    return;
                } else {
                    if (inTable) {
                        html += '</tbody></table></div>';
                        inTable = false;
                    }
                }

                // 1. Headers (H1 - H6)
                const headerMatch = trimmed.match(/^(#{1,6})\s+(.*)$/);
                if (headerMatch) {
                    const level = headerMatch[1].length;
                    const content = headerMatch[2];
                    html += `<h${level}>${escapeHtml(content)}</h${level}>`;
                    if (level === 1) jsonStructure.name = content;
                    currentRadioGroup = null;
                }
                // 2. Syntax: - [type:key (attrs)] Label
                else if (trimmed.startsWith('- [')) {
                    // Regex: - [type:key( attrs)?] Label
                    const match = trimmed.match(/^-\s*\[([a-z]+):([a-zA-Z0-9_]+)(?:\s*\(([^)]+)\))?\]\s*(.*)$/);

                    if (match) {
                        const [_, type, key, attrs, label] = match;
                        currentRadioGroup = null;
                        const cleanLabel = label.trim();

                        if (type === 'radio') {
                            currentRadioGroup = { key, label: cleanLabel, attrs };
                            html += Renderers.radioStart(key, cleanLabel, attrs);
                        } else if (Renderers[type]) {
                            html += Renderers[type](key, cleanLabel, attrs);
                        } else {
                            html += `<p style="color:red">Unknown type: ${type}</p>`;
                        }
                    }
                }
                // 3. Radio Options
                // Support default check: - [x] Label
                else if ((line.startsWith('  - ') || line.startsWith('\t- '))) {
                    if (currentRadioGroup) {
                        let label = trimmed.replace(/^-\s*/, '');
                        let checked = false;
                        // Check for [x] syntax
                        if (label.startsWith('[x] ')) {
                            checked = true;
                            label = label.substring(4);
                        }
                        html += Renderers.radioOption(currentRadioGroup.key, label, label, checked);
                    }
                }
                else if (trimmed.startsWith('---')) {
                    html += '<hr>';
                    currentRadioGroup = null;
                }
                else if (trimmed.length > 0) {
                    if (currentRadioGroup) { html += '</div></div>'; currentRadioGroup = null; }
                    html += `<p>${escapeHtml(trimmed)}</p>`;
                } else {
                    if (currentRadioGroup) { html += '</div></div>'; currentRadioGroup = null; }
                }
            });

            if (inTable) html += '</tbody></table></div>';
            if (currentRadioGroup) html += '</div></div>';

            // Append Debug View for JSON-LD (Web/A requirement)
            html += `<details style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 10px;">
                <summary style="cursor:pointer; color:#666;">View Machine Readable Data (JSON-LD)</summary>
                <pre id="json-debug" style="background:#f5f5f5; padding:10px; border-radius:4px; font-size:12px; overflow:auto;">{}</pre>
            </details>`;

            preview.innerHTML = html;
            window.generatedJsonStructure = jsonStructure;

            // Initial JSON update
            setTimeout(updatePreviewJson, 100);
        }

        function updatePreviewJson() {
            const data = { ...window.generatedJsonStructure };
            document.querySelectorAll('#preview [data-json-path]').forEach(input => {
                const key = input.dataset.jsonPath;
                if (key) data[key] = input.value;
            });
            document.querySelectorAll('#preview input[type=radio]:checked').forEach(r => {
                data[r.name] = r.value;
            });

            const debug = document.getElementById('json-debug');
            if (debug) debug.textContent = JSON.stringify(data, null, 2);
        }

        // Bind live update
        document.getElementById('preview')?.addEventListener('input', updatePreviewJson);

        function htmlAttribute(str) {
            return (str || '').replace(/"/g, '&quot;');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Initialize
        parseAndRender();

        // --- Export Logic (Same as Designer but adapted) ---
        function downloadWebA() {
            const preview = document.getElementById('preview');
            // Extract content
            const contentHtml = preview.innerHTML;
            const json = window.generatedJsonStructure;

            // Runtime Script (The "Web/A Engine")
            // NOTE: This includes the LocalStorage logic we added earlier.
            const runtimeScript = `
        <script>
            const TEMPLATE_ID = 'weba_gen_' + '${Date.now()}';
            const FORM_ID = TEMPLATE_ID + '_' + (location.pathname || '');

            function updateJsonLd() {
                const dataScript = document.getElementById('data-layer');
                const data = JSON.parse(dataScript.textContent);
                document.querySelectorAll('[data-json-path]').forEach(input => {
                    const path = input.dataset.jsonPath;
                    if(path) data[path] = input.value; 
                });
                // Find checked radios that are not "data-json-path" driven usually? 
                // In this Markdown parser, we didn't add data-json-path to radios explicitly in the DOM above?
                // Wait, radios in Renderers don't have data-json-path. Let's handle them.
                document.querySelectorAll('input[type=radio]:checked').forEach(r => {
                    // Use name as key if no json-path
                    data[r.name] = r.value;
                });
                
                dataScript.textContent = JSON.stringify(data, null, 2);
            }

            function saveDocument() {
                updateJsonLd();
                const clone = document.documentElement.cloneNode(true);
                const originalInputs = document.querySelectorAll('input, textarea, select');
                const clonedInputs = clone.querySelectorAll('input, textarea, select');
                originalInputs.forEach((input, index) => {
                    const clonedInput = clonedInputs[index];
                    if (input.type === 'checkbox' || input.type === 'radio') {
                         if (input.checked) clonedInput.setAttribute('checked', 'checked'); else clonedInput.removeAttribute('checked');
                    } else if (input.tagName === 'TEXTAREA') {
                        clonedInput.textContent = input.value;
                    } else {
                        clonedInput.setAttribute('value', input.value);
                    }
                });
                const s = new XMLSerializer();
                const blob = new Blob(["<!DOCTYPE html>\\n" + s.serializeToString(clone)], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = '${(json.name || 'form').replace(/\s+/g, '_')}_filled.html';
                a.click();
            }

            // LocalStorage Auto-Save
            function saveToLS() {
                const data = {};
                document.querySelectorAll('input, textarea').forEach(el => {
                     const key = el.dataset.jsonPath || el.name;
                     if(!key) return;
                     if(el.type === 'radio') { if(el.checked) data[key] = el.value; }
                     else { data[key] = el.value; }
                });
                localStorage.setItem(FORM_ID, JSON.stringify(data));
            }
            function restoreFromLS() {
                const c = localStorage.getItem(FORM_ID);
                if(!c || !confirm('Restore?')) return;
                const d = JSON.parse(c);
                document.querySelectorAll('input, textarea').forEach(el => {
                    const key = el.dataset.jsonPath || el.name;
                    if(d[key] !== undefined) {
                        if(el.type === 'radio') { el.checked = (d[key] === el.value); }
                        else { el.value = d[key]; }
                    }
                });
            }
            let tm;
            document.addEventListener('input', () => { clearTimeout(tm); tm = setTimeout(saveToLS, 1000); });
            window.addEventListener('DOMContentLoaded', restoreFromLS);
        <\/script>`;

            const fullHtml = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>${json.name || 'Form'}</title>
    <style>
        body { font-family: sans-serif; background: #eee; margin: 0; padding: 20px; }
        .page { width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto; background: white; box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-row { display: flex; margin-bottom: 15px; }
        .form-label { width: 150px; font-weight: bold; }
        .form-input { flex: 1; padding: 5px; font-size: 16px; width: 100%; box-sizing: border-box; }
        h1 { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .toolbar { position: fixed; bottom: 20px; right: 20px; display: flex; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; background: #333; color: white; border: none; font-weight:bold; }
        @media print { body{ background:none; padding:0; } .page{ box-shadow:none; } .toolbar{ display:none; } }
    </style>
</head>
<body>
    <script type="application/ld+json" id="data-layer">
    ${JSON.stringify(json, null, 2)}
    <\/script>
    <div class="page">
        ${contentHtml}
    </div>
    <div class="toolbar">
        <button onclick="window.print()">PDF/Print</button>
        <button onclick="saveDocument()">Save (Web/A)</button>
    </div>
    ${runtimeScript}
</body>
</html>`;

            const blob = new Blob([fullHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'web-a-form-markdown.html';
            a.click();
        }
    </script>

</body>

</html>