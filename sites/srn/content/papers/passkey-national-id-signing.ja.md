---
title: "設計メモ: PassKey公開鍵のNational ID署名"
layout: width
date: 2025-01-04
author: "Web/A Project"
description: "PassKey公開鍵をマイナンバーカードの署名用証明書で署名し、本人性を担保する設計方針と実現可能性。"
---

# PassKey公開鍵のNational ID署名 設計メモ

## 1. 目的

PassKey (WebAuthn) は端末内の鍵として安全だが、第三者に対して「誰の鍵か」を証明できない。
そこで、**マイナンバーカードの署名用電子証明書**で PassKey 公開鍵を署名し、本人性を担保する仕組みを設計する。

## 2. 前提とスコープ

- 対象は **PassKey公開鍵の本人性証明**。ID確認そのもののUI/UXは別途検討。
- 署名は **カード内秘密鍵**で実施し、外部へは公開鍵証明書と署名結果を提供する。
- 署名はローカル環境で行う (ブラウザ単体では不可のため)。

## 3. 実現可能性の整理

### 3.1 技術的には可能

- 署名用電子証明書は **公開鍵証明書 (X.509)** と **署名機能**を提供する。
- PassKey公開鍵は登録時に取得可能 (WebAuthnのcredentialPublicKey)。
- これらを **ローカルアプリ/CLI** で結びつけ、署名データを生成できる。

### 3.2 主要な制約

- ブラウザ標準APIだけではカード署名が扱えない。
- 署名用証明書の利用には **カードリーダーやNFC** と **OS側ミドルウェア** が必要。
- 失効確認 (CRL/OCSP) は実装負担がある。

## 4. 署名対象データの設計

### 4.1 署名する内容

PassKey公開鍵そのものだけでなく、以下を束ねて署名する。

- PassKey公開鍵 (COSE Key or JWK)
- 鍵識別子 (credentialId)
- 発行時刻 (createdAt)
- 依拠先 (rpId)

### 4.2 カノニカル化

- 署名対象は **安定したJSON文字列**に変換してからハッシュ化する。
- 例: JCS (JSON Canonicalization Scheme) を採用。

## 5. 署名形式

### 5.1 推奨形式

- **CMS/PKCS#7** 署名を採用し、X.509証明書チェーンを内包する。
- 署名アルゴリズムは証明書の鍵種に従う (RSA or ECDSA)。

### 5.2 成果物

- `passkey-binding.json` (署名対象データ)
- `passkey-binding.p7s` (CMS署名)
- これらを **VC形式**でラップして Folio に保存する。

## 6. 検証フロー

1. `passkey-binding.json` と署名ファイルを取得
2. CMS署名の検証 (証明書チェーン)
3. 署名対象の正当性チェック (canonical JSON一致)
4. 証明書の失効確認 (CRL/OCSP)

## 7. Folioとの統合イメージ

- Folio内に `keys/passkey-binding/` を作成し、署名成果物を格納。
- 提出時は VC/VP として同梱し、PassKey署名と **二段階の証明**を構成。

## 8. リスクと留意点

- 証明書失効時の扱い (更新・再署名のフロー)
- 署名時の利用者確認プロセス (PIN入力等)
- 署名対象の範囲が曖昧だと **再バインド攻撃**が成立しうる

## 9. 実装ステップ案

1. PassKey公開鍵の抽出 (WebAuthn登録時に取得)
2. 署名対象JSONの生成とカノニカル化
3. ローカルCLIでカード署名を実施
4. 署名成果物の検証ツールを実装
5. Folio連携 (保存・VP生成)
