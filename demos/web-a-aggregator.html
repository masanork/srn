<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web/A Aggregator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        #drop-zone {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            background: #f9f9f9;
            transition: background 0.2s;
        }

        #drop-zone.dragover {
            background: #e0e0e0;
            border-color: #999;
        }

        #output-area {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background: #f8f8f8;
        }

        .actions {
            margin-bottom: 20px;
            display: none;
        }

        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        .error {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <h1>Web/A Aggregator</h1>
    <p>Drop multiple Web/A HTML files here to aggregate their JSON-LD data.</p>

    <div id="drop-zone">
        Drag & Drop Web/A (.html) files here<br>
        <input type="file" id="file-input" multiple accept=".html" style="display:none">
        <button onclick="document.getElementById('file-input').click()" style="margin-top:10px; background:#666;">Or
            Select Files</button>
    </div>

    <div class="actions" id="actions">
        <button onclick="downloadCSV()">Download as CSV</button>
        <button onclick="downloadJSON()">Download as JSON</button>
        <span id="stats" style="margin-left: 10px; color: #666;"></span>
    </div>

    <div id="output-area"></div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const outputArea = document.getElementById('output-area');
        const actions = document.getElementById('actions');
        const stats = document.getElementById('stats');

        let aggregatedData = [];
        let allKeys = new Set();

        // -- Event Listeners --
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', handleDrop);
        document.getElementById('file-input').addEventListener('change', (e) => processFiles(e.target.files));

        function handleDrop(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            processFiles(e.dataTransfer.files);
        }

        async function processFiles(files) {
            aggregatedData = [];
            allKeys = new Set(['_filename']); // Reserved key for filename
            outputArea.innerHTML = '<p>Processing...</p>';

            for (const file of files) {
                if (!file.name.endsWith('.html')) continue;

                try {
                    const text = await file.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');

                    // Find JSON-LD script (id="data-layer" or plain ld+json)
                    // Web/A Standard: <script type="application/ld+json" id="data-layer">
                    let script = doc.getElementById('data-layer');
                    if (!script) {
                        script = doc.querySelector('script[type="application/ld+json"]');
                    }

                    if (script) {
                        try {
                            const json = JSON.parse(script.textContent);
                            // Flatten JSON if needed or just use top-level keys
                            // For tables (arrays), we might need special handling. 
                            // For simple CSV export, we'll stringify objects/arrays.
                            const row = { '_filename': file.name };

                            Object.keys(json).forEach(k => {
                                if (k.startsWith('@')) return; // Skip JSON-LD meta

                                const val = json[k];
                                allKeys.add(k);

                                if (typeof val === 'object' && val !== null) {
                                    row[k] = JSON.stringify(val); // Cell contains JSON string for complex data
                                } else {
                                    row[k] = val;
                                }
                            });
                            aggregatedData.push(row);
                        } catch (e) {
                            console.error('JSON Parse Error in ' + file.name, e);
                        }
                    }
                } catch (e) {
                    console.error('File Read Error', e);
                }
            }

            renderTable();
        }

        function renderTable() {
            if (aggregatedData.length === 0) {
                outputArea.innerHTML = '<p>No valid Web/A data found.</p>';
                actions.style.display = 'none';
                return;
            }

            const sortedKeys = Array.from(allKeys);
            // Put _filename first
            sortedKeys.sort((a, b) => {
                if (a === '_filename') return -1;
                if (b === '_filename') return 1;
                return a.localeCompare(b);
            });

            let html = '<table><thead><tr>';
            sortedKeys.forEach(k => html += `<th>${k}</th>`);
            html += '</tr></thead><tbody>';

            aggregatedData.forEach(row => {
                html += '<tr>';
                sortedKeys.forEach(k => {
                    html += `<td>${escapeHtml(row[k] !== undefined ? row[k] : '')}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            outputArea.innerHTML = html;
            stats.textContent = `${aggregatedData.length} files processed.`;
            actions.style.display = 'block';
        }

        function downloadCSV() {
            if (aggregatedData.length === 0) return;
            const sortedKeys = Array.from(allKeys).sort((a, b) => (a === '_filename' ? -1 : b === '_filename' ? 1 : a.localeCompare(b)));

            const csvContent = [
                sortedKeys.join(','),
                ...aggregatedData.map(row => sortedKeys.map(k => {
                    let val = row[k] === undefined ? '' : String(row[k]);
                    // Escape CSV special chars
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = `"${val.replace(/"/g, '""')}"`;
                    }
                    return val;
                }).join(','))
            ].join('\n');

            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv' }); // Add BOM for Excel
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'weba_aggregation.csv';
            a.click();
        }

        function downloadJSON() {
            const blob = new Blob([JSON.stringify(aggregatedData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'weba_aggregation.json';
            a.click();
        }

        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    </script>
</body>

</html>